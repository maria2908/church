<!doctype html>
<html lang="ua">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Усі пости</title>
  <link rel="stylesheet" href="/assets/styles/index.css">
  <link rel="stylesheet" type="text/css" href="./assets/styles/style.css"/>
  <link rel="stylesheet" type="text/css" href="./assets/styles/spinner.css"/>
  <link rel="icon" href="./assets/img/logo.png">

  <meta name="description" content="Новини та оголошення парафії 'Всіх Святих' у Регенсбурзі. Читайте всі пости.">
  <link rel="canonical" href="https://ukrainian-orthodox-regensburg.netlify.app/posts.html">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Усі пости — Парафія Всіх Святих">
  <meta property="og:description" content="Новини та оголошення парафії у Регенсбурзі.">
  <meta property="og:url" content="https://ukrainian-orthodox-regensburg.netlify.app/posts.html">
  <meta property="og:image" content="https://ukrainian-orthodox-regensburg.netlify.app/assets/img/main-img.jpg">
<!-- JSON-LD: Blog -->
  <script type="application/ld+json">
    {
      "@context":"https://schema.org",
      "@type":"Blog",
      "name":"Пости парафії",
      "url":"https://ukrainian-orthodox-regensburg.netlify.app/posts.html",
      "publisher":{"@type":"Organization","name":"Парафія Всіх Святих"}
    }
  </script>
</head>
<body>
  <div class="wrap main-posts">
    <h1>Усі пости</h1>
    <p><a href="/">← Назад на головну</a></p>
    <div id="loader" class="loader" aria-live="polite">
        <div class="spinner" role="status" aria-label="Завантаження"></div>
    </div>
    <div id="posts" class="posts"><p class="muted"></p></div>
    <p style="text-align:center; padding: 5px 0; margin: 0;"><button id="moreBtn" class="btn">Загрузити ще</button></p>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL  = 'https://xsxorgfkhmeinjrosprt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzeG9yZ2ZraG1laW5qcm9zcHJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjkxMjgsImV4cCI6MjA3MDc0NTEyOH0.ojkysEKiLi5xttq7WyfEnt3xjF4PhIVG1tdxrimjTi8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const postsEl = document.getElementById('posts');
    const moreBtn = document.getElementById('moreBtn');
    const PAGE = 12;
    let page = 0;
    const esc = s => (s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    
    const preview = (txt, n=100) => {
        const s = (txt ?? '').trim();
        if (s.length <= n) return s;
        const cut = s.slice(0, n);
        const i = cut.lastIndexOf(' ');
        return (i > 60 ? cut.slice(0, i) : cut) + '…';
    };

    const loader = document.getElementById('loader');

    async function loadMore() {
      loader.classList.add('show');
        moreBtn.disabled = true; // чтобы не накликивали
        const from = page * PAGE;
        const to   = from + PAGE - 1;

        const { data: posts, error } = await supabase
            .from('posts')
            .select('*')
            .order('published_at', { ascending: false })
            .range(from, to);

        loader.classList.remove('show');

        if (error) {
            console.error(error);
            if (page === 0) postsEl.innerHTML = `<p class="muted">Ошибка загрузки.</p>`;
            moreBtn.disabled = false;
            return;
        }

        if (!posts?.length) {
            if (page === 0) postsEl.innerHTML = `<p class="muted">Постов пока нет.</p>`;
            moreBtn.disabled = true;
            moreBtn.textContent = 'Больше нет';
            return;
        }

        // САМЫЙ ВАЖНЫЙ МОМЕНТ: убираем "Загружаем…" на первой странице
        if (page === 0) postsEl.innerHTML = '';

        const html = posts.map(p => `
            <article class="post">
            ${p.cover_url ? `<img class="cover" src="${p.cover_url}" alt="">` : ''}
            <h3>${esc(p.title)}</h3>
            <p>${esc(preview(p.body, 100))}</p>
            <p><a class="btn" href="/post.html?id=${encodeURIComponent(p.id)}">Читати більше</a></p>
            <small class="muted">${new Date(p.published_at).toLocaleString()}</small>
            </article>
        `).join('');

        postsEl.insertAdjacentHTML('beforeend', html);

        page++;
        if (posts.length < PAGE) {
            moreBtn.disabled = true;
            moreBtn.textContent = 'Усі пости загружені';
        } else {
            moreBtn.disabled = false;
        }
    }

    moreBtn.onclick = loadMore;
    loadMore();
  </script>
</body>
</html>
